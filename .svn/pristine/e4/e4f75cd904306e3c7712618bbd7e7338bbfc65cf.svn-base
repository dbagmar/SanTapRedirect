//
//  MessagesParentViewController.swift
//  TecladoiMessage
//
//  Created by Darshan Bagmar on 19/05/20.
//  Copyright Â© 2020 IDmission. All rights reserved.
//

import UIKit
import Messages
var genratURLModel:GenerateURLModelResponse?
open class MessagesParentViewController: MSMessagesAppViewController {
    var messageUi:Bool?
    override open func viewDidLoad() {
        super.viewDidLoad()
        // Do any additional setup after loading the view.
    }
    
    // MARK: - Conversation Handling
    
    override open func willBecomeActive(with conversation: MSConversation) {
        // Called when the extension is about to move from the inactive to active state.
        // This will happen when the extension is about to present UI.
        
       
            // Use this method to configure the extension and restore previously stored state.
                  presentRatingsViewController(for: conversation, with: self.presentationStyle)
    
        
      
    }
    
    override open func didResignActive(with conversation: MSConversation) {
        // Called when the extension is about to move from the active to inactive state.
        // This will happen when the user dissmises the extension, changes to a different
        // conversation or quits Messages.
        
        // Use this method to release shared resources, save user data, invalidate timers,
        // and store enough state information to restore your extension to its current state
        // in case it is terminated later.
    }
   
    override open func didReceive(_ message: MSMessage, conversation: MSConversation) {
        // Called when a message arrives that was generated by another instance of this
        // extension on a remote device.
        
        // Use this method to trigger UI updates in response to the message.
        
    }
    
    override open func didStartSending(_ message: MSMessage, conversation: MSConversation) {
        // Called when the user taps the send button.
    }
    
    override open func didCancelSending(_ message: MSMessage, conversation: MSConversation) {
        // Called when the user deletes the message without sending it.
    
        // Use this to clean up state related to the deleted message.
    }
    
    override open func willTransition(to presentationStyle: MSMessagesAppPresentationStyle) {
        // Called before the extension transitions to a new presentation style.
    
        // Use this method to prepare for the change in presentation style.
        
        guard let conversation = activeConversation else { fatalError("Expected an active converstation") }
        
        //presentRatingsViewController(for: conversation, with: presentationStyle)
    }
    
    override open func didTransition(to presentationStyle: MSMessagesAppPresentationStyle) {
        // Called after the extension transitions to a new presentation style.
    
        // Use this method to finalize any behaviors associated with the change in presentation style.
    }
    
    override open func didSelect(_ message: MSMessage, conversation: MSConversation) {
        super.didSelect(message, conversation: conversation)
    }
    
    
    func presentRatingsViewController(for conversation: MSConversation, with presentationStyle: MSMessagesAppPresentationStyle){
           let viewcontroller : UIViewController
        
        
        if let message = conversation.selectedMessage {
        // message selected

        // Eg. open your app:
        let url = message.url// your apps url
        let context = NSExtensionContext()
        context.open(url! as URL, completionHandler: nil)

        var responder = self as UIResponder?
        while (responder != nil){
            if responder?.responds(to: Selector("openURL:")) == true{
                responder?.perform(Selector("openURL:"), with: url)
            }
            responder = responder!.next
        }
            
            
            
        }else{
            
            let vc:CustomMessageViewController = CustomMessageViewController.init(nibName: nil, bundle:Bundle(for: CustomMessageViewController.self))
                vc.delegate = self
                viewcontroller = vc
                     for child in children {
                           child.willMove(toParent: nil)
                           child.view.removeFromSuperview()
                           child.removeFromParent()
                       }
                       
                       addChild(viewcontroller)
                       viewcontroller.view.frame = view.bounds
                       viewcontroller.view.translatesAutoresizingMaskIntoConstraints = false
                       view.addSubview(viewcontroller.view)
                       viewcontroller.view.leftAnchor.constraint(equalTo: view.leftAnchor).isActive = true
                       viewcontroller.view.rightAnchor.constraint(equalTo: view.rightAnchor).isActive = true
                       viewcontroller.view.topAnchor.constraint(equalTo: view.topAnchor).isActive = true
                       viewcontroller.view.bottomAnchor.constraint(equalTo: view.bottomAnchor).isActive = true
                       viewcontroller.didMove(toParent: self)
        
        }
        
           
       }

    
    fileprivate func composeMessage(with messageDetail: GenerateURLModelResponse, layoutImg: UIImage?, session: MSSession? = nil) -> MSMessage? {
        var components = URLComponents()
    
        guard let decodedCaption = messageDetail.body?.link else { return nil }
        let caption = URLQueryItem(name: "caption", value: decodedCaption)
        
        let layout = MSMessageTemplateLayout()
        
        guard let image = layoutImg else { return nil }
        layout.image = image
       // layout.caption =  "\(genratURLModel?.body?.message ?? " ")"
        components.queryItems = [caption]
      //  components.url = URL.init(string: genratURLModel?.body?.link)
        
        let message = MSMessage(session: session ?? MSSession())
        
        if let conversation = activeConversation,
            let msg = conversation.selectedMessage{
            if msg.senderParticipantIdentifier == conversation.localParticipantIdentifier {
                let url = URL.init(string: (messageDetail.body!.link))// your apps url
                self.extensionContext?.open(url!, completionHandler: { (success: Bool) in

                })
            }
            else{
                
                let url = URL.init(string: (messageDetail.body!.link))// your apps url
                self.extensionContext?.open(url!, completionHandler: { (success: Bool) in

                })
            }
        }
    
        message.url = URL.init(string: (messageDetail.body!.link))
        message.layout = layout

        return message
    }
}


extension MessagesParentViewController:CustomMessageViewControllerDelegate{
    func addURLMessage(_ item: GenerateURLModelResponse, layoutImg: UIImage?) {
        guard let conversation = activeConversation else { fatalError("Expected a conversation") }

               guard let message = composeMessage(with: item, layoutImg: layoutImg, session: conversation.selectedMessage?.session)
                   else { return }
               
               // Add the message to the conversation.
               conversation.insert(message) { error in
                   if let error = error {
                       print(error)
                   }
               }
               
               dismiss()
           }
    
    func setMessageUi(setMessageUi: Bool) {
          // messageUi = setMessageUi
        dismiss()
          // requestPresentationStyle(.expanded)
       }
    
}



